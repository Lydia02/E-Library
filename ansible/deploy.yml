---
- name: Deploy E-Library to Production
  hosts: app_servers
  become: yes
  gather_facts: yes

  tasks:
    - name: Login to Azure Container Registry
      command: >
        docker login {{ lookup('env', 'ACR_LOGIN_SERVER') }}
        -u {{ lookup('env', 'AZURE_CLIENT_ID') }}
        -p {{ lookup('env', 'AZURE_CLIENT_SECRET') }}
      no_log: true

    - name: Create application directory
      file:
        path: /opt/e-library
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'

    - name: Copy docker-compose file
      copy:
        src: ../docker-compose.yml
        dest: /opt/e-library/docker-compose.yml
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0644'

    - name: Copy Firebase service account key
      copy:
        src: files/serviceAccountKey.json
        dest: /opt/e-library/serviceAccountKey.json
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0666'  # ← Changed to 0666 (world-readable)

    - name: Create environment file
      copy:
        dest: /opt/e-library/.env
        content: |
          ACR_LOGIN_SERVER={{ lookup('env', 'ACR_LOGIN_SERVER') }}
          IMAGE_TAG={{ lookup('env', 'IMAGE_TAG') }}
          DB_HOST={{ lookup('env', 'DB_HOST') }}
          DB_PORT={{ lookup('env', 'DB_PORT') }}
          DB_NAME={{ lookup('env', 'DB_NAME') }}
          DB_USER={{ lookup('env', 'DB_USER') }}
          DB_PASSWORD={{ lookup('env', 'DB_PASSWORD') }}
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'
      no_log: true

    - name: Stop existing containers
      command: docker-compose down
      args:
        chdir: /opt/e-library
      ignore_errors: yes

    - name: Pull latest images
      command: docker-compose pull
      args:
        chdir: /opt/e-library
      environment:
        ACR_LOGIN_SERVER: "{{ lookup('env', 'ACR_LOGIN_SERVER') }}"
        IMAGE_TAG: "{{ lookup('env', 'IMAGE_TAG') }}"

    - name: Start services
      command: docker-compose up -d
      args:
        chdir: /opt/e-library
      environment:
        ACR_LOGIN_SERVER: "{{ lookup('env', 'ACR_LOGIN_SERVER') }}"
        IMAGE_TAG: "{{ lookup('env', 'IMAGE_TAG') }}"
        DB_HOST: "{{ lookup('env', 'DB_HOST') }}"
        DB_PORT: "{{ lookup('env', 'DB_PORT') }}"
        DB_NAME: "{{ lookup('env', 'DB_NAME') }}"
        DB_USER: "{{ lookup('env', 'DB_USER') }}"
        DB_PASSWORD: "{{ lookup('env', 'DB_PASSWORD') }}"

    - name: Wait for containers to initialize
      pause:
        seconds: 30

    - name: Check container status
      command: docker ps --format "table {{.Names}}\t{{.Status}}"
      args:
        chdir: /opt/e-library
      register: containers

    - name: Display container status
      debug:
        msg: "{{ containers.stdout_lines }}"

    - name: Check backend logs for errors
      command: docker logs elibrary-backend --tail 50
      args:
        chdir: /opt/e-library
      register: backend_logs
      ignore_errors: yes

    - name: Display backend logs
      debug:
        msg: "{{ backend_logs.stdout_lines }}"
      when: backend_logs.stdout_lines is defined

    - name: Display deployment info
      debug:
        msg:
          - "✅ Deployment completed!"
          - "Frontend: http://52.176.217.99:3000"
          - "Backend: http://52.176.217.99:5000"
          - "Note: Backend may take 1-2 minutes to connect to Firebase and PostgreSQL"